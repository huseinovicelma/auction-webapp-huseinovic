<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaureAsta</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    /> 
    <script src="assets/main.js" defer></script>
    <link rel="stylesheet" type="text/css" href="assets/app.css">
    <!-- Import Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>


    
  </head>

  <body id="app">
    <!--Navbar-->
    <nav class="navbar navbar-light bg-body-tertiary">
      <div class="container d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between">
        <!-- Sinistra: Navbar brand e link principali -->
        <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center">
          <a class="navbar-brand me-lg-4" @click="showPage('mainpage')">LaureAsta</a>
    
          <ul class="navbar-nav d-flex flex-column flex-lg-row mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="#" @click="showPage('userList')">Lista utenti</a>
            </li>
            <li v-if="isLoggedIn" class="nav-item">
              <a class="nav-link" href="#" @click="showPage('newauction')">Crea Nuova Asta</a>
            </li>
          </ul>
        </div>
    
        <!-- Destra: Login/Registrazione o Dropdown utente -->
        <div v-if="!isLoggedIn" class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center">
          <button data-mdb-ripple-init type="button" class="btn btn-primary me-lg-3 mb-2 mb-lg-0" @click="showPage('login')">
            Login
          </button>
          <button data-mdb-ripple-init type="button" class="btn btn-primary me-lg-3 mb-2 mb-lg-0" @click="showPage('signin')">
            Registrazione
          </button>
        </div>
        <div v-if="isLoggedIn" class="d-flex align-items-center">
          <div class="dropdown position-relative">
            <!-- Pulsante Dropdown -->
            <button 
              class="btn btn-secondary dropdown-toggle" 
              id="menu"
              type="button"
              ref="dropdownButton"
              @click="toggleDropdown"
            >
              Ciao, {{ username }}
            </button>
        
            <!-- Menu Dropdown -->
            <ul 
              class="dropdown-menu dropdown-menu-end position-absolute mt-1" 
              ref="dropdownMenu"
              style="right: 0; z-index: 1050;"
            >
              <li>
                <a class="dropdown-item" href="#" @click="showPage('profile')">Profilo</a>
              </li>
              <li>
                <a class="dropdown-item" href="#" @click="showPage('login'); logout()">Cambia account</a>
              </li>
              <li>
                <a class="dropdown-item" href="#" @click="showPage('mainpage'); logout()">Logout</a>
              </li>
            </ul>
          </div>
        </div>
        
        
        
        
        
        
      </div>
    </nav>
  
    <!--Messaggi di successo/errore-->
    <div class="container mt-5">
      <div v-if="successMessage" class="alert alert-success mt-3" role="alert">
        {{ successMessage }}
      </div>
    
      <div v-if="errorMessage" class="alert alert-danger mt-3" role="alert">
        {{ errorMessage }}
      </div>
    </div>

    <!--Mainpage: pagina con la lista delle aste-->
    <div v-if="currentView === 'mainpage'" class="container mt-5">
      <div class="container mt-4">
        <div class="row justify-content-center">
          <div class="col-md-6">
            <div class="input-group">
              <!-- Barra di ricerca -->
              <input
                type="text"
                class="form-control"
                placeholder="Cerca asta..."
                aria-label="Cerca asta"
                aria-describedby="search-button"
                v-model="searchQuery" 
              />
              <button
                class="btn btn-outline-primary"
                type="button"
                id="search-button"
                @click="filterAsta" 
              >
                <i class="bi bi-search"></i> Cerca
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <!-- Asta Card -->
        <div
          v-for="auction in auctions"
          :key="auction.id"
          class="col-12 mb-4"
        >
          <div class="card bg-dark text-white shadow-sm w-100" id="clickableCard" @click="loadAuctionDetail(auction.id); currentView = 'auctionDetail'">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <h5 class="card-title">{{ auction.title }}</h5>
                <!-- Badge indicante se l'asta è attiva o scaduta -->
                <span
                  v-if="auction.expired"
                  class="badge bg-danger ms-auto">Scaduta</span>
                <span
                  v-else
                  class="badge bg-success ms-auto">Attiva</span>
              </div>
              <p class="card-text">{{ auction.description }}</p>
              <p class="card-text">
                <strong>Data di fine:</strong> {{ auction.endDate }}
              </p>
            </div>
            <div
            class="card-footer d-flex justify-content-between align-items-center"
            style="border-top: 1px solid #444;"
            >
              <small>ID Asta: <span class="auction-id">{{ auction.id }}</span></small>
              <span class="badge custom-orange">Click for details</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!--Pagina di Login-->
    <div v-if="currentView === 'login'" class="container mt-5">
      <h2>Login</h2>
      <form @submit.prevent="handleLogin">
        <div class="mb-3">
          <label for="login-username" class="form-label">Username</label>
          <input type="text" id="login-username" v-model="loginData.username" class="form-control" required />
        </div>
        <div class="mb-3">
          <label for="login-password" class="form-label">Password</label>
          <input type="password" id="login-password" v-model="loginData.password" class="form-control" required />
        </div>
        <button type="submit" class="btn btn-primary">Accedi</button>
        <button type="button" class="btn btn-secondary" @click="showPage('mainpage')">Annulla</button>
      </form>
    </div>

    <!--Pagina di Registrazione-->
    <div v-if="currentView === 'signin'" class="container mt-5">
      <h2 class="mb-4">Registrazione</h2>
      <form @submit.prevent="handleRegistration">
        <div class="mb-3">
          <label for="signup-name" class="form-label">Name</label>
          <input
            type="text"
            id="signup-name"
            v-model="registrationData.name"
            class="form-control"
            required
          />
        </div>
        <div class="mb-3">
          <label for="signup-surname" class="form-label">Surname</label>
          <input
            type="text"
            id="signup-surname"
            v-model="registrationData.surname"
            class="form-control"
            required
          />
        </div>
        <div class="mb-3">
          <label for="signup-username" class="form-label">Username</label>
          <input
            type="text"
            id="signup-username"
            v-model="registrationData.username"
            class="form-control"
            required
          />
        </div>
        <div class="mb-3">
          <label for="signup-password" class="form-label">Password</label>
          <input
            type="password"
            id="signup-password"
            v-model="registrationData.password"
            class="form-control"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary">Registrati</button>
        <button type="button" class="btn btn-secondary" @click="showPage('mainpage')">Annulla</button>
      </form>
    </div>

    <!--Profilo Utente-->
    <div v-if="currentView === 'profile'" class="container mt-5">
      <div class="row mb-4 justify-content-center">
        <!-- Profilo utente -->
        <div class="col-md-8">
          <div class="card bg-dark text-white shadow-lg border-0">
            <div class="card-header bg-dark text-white text-center">
              <h4 class="mb-0">Profilo di {{ user.username }}</h4>
            </div>
            <div class="card-body">
              <div class="d-flex flex-column align-items-start">
                <!-- Dettagli utente senza l'ID -->
                <p><strong>Nome:</strong> {{ user.name }}</p>
                <p><strong>Cognome:</strong> {{ user.surname }}</p>
              </div>
            </div>
            <div class="card-footer bg-dark text-white">
              <small>ID Utente: <span class="user-id">{{ user.id }}</span></small>
            </div>
          </div>
        </div>
      </div>
      

      <div class="row mb-4">
        <div class="col-md-12">
          <div class="btn-group w-100" role="group">
            <button 
              class="btn btn-lg btn-outline-primary w-50" 
              :class="{'active': showView === 'created'}" 
              @click="showView = 'created'">
              Aste Create
            </button>
            <button 
              class="btn btn-lg btn-outline-primary w-50" 
              :class="{'active': showView === 'won'}" 
              @click="showView = 'won'">
              Aste Vinte
            </button>
          </div>
        </div>
      </div>

      <!-- Contenuto Aste -->
      <div v-if="showView === 'created' && createdAuctions.length" class="row">
        <div v-for="auction in createdAuctions" :key="auction.id" class="col-12 mb-4">
          <div class="card bg-dark text-white shadow-sm w-100" id="clickableCard" @click.stop="loadAuctionDetail(auction.id); currentView = 'auctionDetail'">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <h5 class="card-title">{{ auction.title }}</h5>
                <!-- Badge indicante se l'asta è attiva o scaduta -->
                <span
                  v-if="auction.expired"
                  class="badge bg-danger ms-auto">Scaduta</span>
                <span
                  v-else
                  class="badge bg-success ms-auto">Attiva</span>
              </div>
              <p class="card-text">{{ auction.description }}</p>
              <small class="d-block">Data di fine: {{ auction.endDate }}</small>
            </div>
            <div
            class="card-footer d-flex justify-content-between align-items-center"
            style="border-top: 1px solid #444;"
            >
              <small>ID Asta: <span class="auction-id">{{ auction.id }}</span></small>
              <span class="badge custom-orange">Click for details</span>
            </div>
          </div>
        </div>
      </div>

      <div v-if="showView === 'won' && wonAuctions.length" class="row">
        <div v-for="auction in wonAuctions" :key="auction.id" class="col-12 mb-4">
          <div class="card bg-dark text-white shadow-sm w-100" id="clickableCard" @click.stop="loadAuctionDetail(auction.id); currentView = 'auctionDetail'">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <h5 class="card-title">{{ auction.title }}</h5>
                <!-- Badge indicante se l'asta è attiva o scaduta -->
                <span
                  v-if="auction.expired"
                  class="badge bg-danger ms-auto">Scaduta</span>
                <span
                  v-else
                  class="badge bg-success ms-auto">Attiva</span>
              </div>
              <p class="card-text">{{ auction.description }}</p>
              <small class="d-block">Data di fine: {{ auction.endDate }}</small>
            </div>
            <div
            class="card-footer d-flex justify-content-between align-items-center"
            style="border-top: 1px solid #444;"
            >
              <small>ID Asta: <span class="auction-id">{{ auction.id }}</span></small>
              <span class="badge custom-orange">Click for details</span>
            </div>
          </div>
        </div>
      </div>
      <div v-if="showView === 'won' && !wonAuctions.length" class="alert alert-warning" role="alert">
        Non hai ancora vinto alcuna asta!
      </div>
      <div v-if="showView === 'created' && !createdAuctions.length" class="alert alert-warning" role="alert">
          Non hai ancora creato un'asta, <a @click="showPage('newauction')" class="links">crea una nuova asta!</a>
       </div>
    </div>

    <!--Pagina dettaglio asta-->
    <div v-if="currentView === 'auctionDetail'" class="container mt-5">
      <div class="row mb-4 justify-content-center">
        <div class="col-md-8">
          <div class="card bg-dark text-white shadow-lg rounded-3 border-0">
            <div class="card-header bg-dark text-white text-center border-bottom">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold fs-4">{{ auctionDetail.title }}</h5>
                <!-- Badge Attiva/Scaduta posizionato a destra -->
                <span v-if="auctionDetail.expired" class="badge bg-danger text-white fs-6 py-2 px-3">Scaduta</span>
                <span v-else class="badge bg-success text-white fs-6 py-2 px-3">Attiva</span>
              </div>
            </div>
            <div class="card-body">
              <p class="card-text mb-3 text-muted fs-6">{{ auctionDetail.description }}</p>
              <div class="text-light fs-5">
                <strong class="fs-6">Creata da:</strong> <em>{{ auctionDetail.createdusername }}</em>
              </div>
              <div class="mb-2 text-light fs-5">
                <strong class="fs-6">Offerta corrente:</strong> <span class="fs-4">€{{ auctionDetail.currentPrice }}</span>
              </div>
              <div class="text-light fs-5">
                <strong class="fs-6">Fornita da:</strong> <em>{{ auctionDetail.assignedTousername }}</em>
              </div>
      
              <!-- Separazione tra la scadenza centrata e il footer -->
              <div v-if="!auctionDetail.expired" class="mt-4 text-center">
                <p class="text-white fs-5 mb-0"><strong>Scadenza:</strong></p>
                <p class="text-light fs-6 mb-0">{{ auctionDetail.endDate }}</p>
              </div>
            </div>
      
            <!-- Footer in fondo -->
            <div class="card-footer">
              <small>ID Asta: <span class="auction-id">{{ auctionDetail.id }}</span></small>
            </div>
          </div>
        </div>
      </div>
      
      <div v-if = "isLoggedIn" >
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="btn-group w-100" role="group">
              <button 
                class="btn btn-lg btn-outline-primary w-50" 
                :class="{'active': showbids === 'allBids'}" 
                @click.stop="showbids = 'allBids'">
                Lista offerte
              </button>
              <button v-if="!isOwner && !auctionDetail.expired"
                class="btn btn-lg btn-outline-primary w-50" 
                :class="{'active': showbids === 'newBid'}" 
                @click="showbids = 'newBid'">
                Nuova offerta
              </button>
              <button v-if = "isOwner && !auctionDetail.expired"
                class="btn btn-lg btn-outline-primary w-50" 
                :class="{'active': showbids === 'modifyauction'}" 
                @click.stop="showbids = 'modifyauction'">
                Modifica Asta
              </button>
              <button v-if = "isOwner && !auctionDetail.expired"
                class="btn btn-lg btn-outline-primary w-50" 
                @click.stop="confirmDeleteAuction(auctionDetail.id)">
                Cancella Asta
              </button>
            </div>
          </div>
        </div>

        <div v-if="showbids === 'allBids'" class="row">
          <div v-if="bids.length">
            <div class="row">
              <div 
                v-for="bid in bids" 
                :key="bid.id" 
                class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4 d-flex"
              >
                <div class="card bg-dark text-white shadow-sm w-100">
                  <div class="card-body p-3">
                    <!-- Contenuto della card -->
                    <p class="card-text mb-1">Valore Offerta: €{{ bid.bidAmount }}</p>
                    <small class="d-block mb-2">Data: {{ bid.timestamp }}</small>
                    <p class="card-text mb-0">Utente: <span class="bid-username">{{ bid.username }}</span></p>
                  </div>
                  <div class="card-footer p-2">
                    <small>ID Offerta: <span class="bid-id">{{ bid.id }}</span></small>
                  </div>
                </div>
              </div>
            </div>
                           
          </div>
          <div v-if="!bids.length" class="alert alert-warning" role="alert">
            Non ci sono ancora state offerte per l'asta
          </div>
        </div>

        <div v-if="showbids === 'newBid'" class="row">
          <div class="col-12 mt-4">
            <div div class="card bg-dark text-white shadow-sm w-100">
              <div class="card-body">
                <form @submit.prevent="insertNewBid">
                  <div class="mb-3">
                    <label for="bidAmount" class="form-label">Importo Offerta</label>
                    <input
                      type="number"
                      id="bidAmount"
                      class="form-control"
                      v-model="newBid.bidAmount"
                      placeholder="Inserisci l'importo"
                      required
                    />
                  </div>
                  <button type="submit" class="btn btn-primary w-100">Invia Offerta</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div v-if="showbids === 'modifyauction'" class="row">
          <div class="col-12 mt-4">
            <div div class="card bg-dark text-white shadow-sm w-100">
              <div class="card-body">
                <h2 class="mb-4">Modifica Asta</h2>
                <form @submit.prevent="editAuction(auctionDetail.id)">
                  <div class="mb-3">
                    <label for="edit-title" class="form-label">Nuovo titolo</label>
                    <input
                      type="text"
                      id="edit-title"
                      v-model="modifyAuction.title"
                      class="form-control"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="edit-description" class="form-label">Nuova descrizione</label>
                    <input
                      type="text"
                      id="edit-description"
                      v-model="modifyAuction.description"
                      class="form-control"
                      required
                    />
                  </div>
                  <button type="submit" class="btn btn-primary">Invia Modifica</button>
                  <button type="button" class="btn btn-secondary" @click="showPage('mainpage')">Annulla</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div v-if = "!isLoggedIn && !auctionDetail.expired" class="alert alert-warning" role="alert">
          <a @click="showPage('login')" class="links">Accedi</a> 
          o <a @click="showPage('signin')" class="links">Registrati</a> per fare un offerta!
        </div>
        <div v-if = "!isLoggedIn && auctionDetail.expired" class="alert alert-warning" role="alert">
          <a @click="showPage('login')" class="links">Accedi</a> 
          o <a @click="showPage('signin')" class="links">Registrati</a> 
           per visualizzare lo storico delle offerte!
        </div>
      </div>
    </div>
    
    <!--Pagina creazione nuova asta-->
    <div v-if="currentView === 'newauction'" class="container mt-5">
      <h2 class="mb-4">Nuova Asta</h2>
      <form @submit.prevent="createNewauction">
        <div class="mb-3">
          <label for="auction-title" class="form-label">Titolo</label>
          <input
            type="text"
            id="auction-title"
            v-model="newAuction.title"
            class="form-control"
            required
          />
        </div>
        <div class="mb-3">
          <label for="auction-description" class="form-label">Descrizione</label>
          <input
            type="text"
            id="auction-description"
            v-model="newAuction.description"
            class="form-control"
            required
          />
        </div>
        <div class="mb-3">
          <label for="auction-endDate" class="form-label">Data di fine:</label>
          <input
            type="datetime-local"
            id="auction-endDate"
            v-model="newAuction.endDate"
            class="form-control"
            required
          />
        </div>
        <div class="mb-3">
          <label for="auction-startingPrice" class="form-label">Offerta di partenza</label>
          <input
            type="number"
            id="auction-startingPrice"
            v-model="newAuction.startingPrice"
            class="form-control"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary">Crea Asta</button>
        <button type="button" class="btn btn-secondary" @click="showPage('mainpage')">Annulla</button>
      </form>
    </div>

    <!--Pagina Lista utenti-->
    <div v-if="currentView === 'userList'" class="container mt-5">
      <div class="container mt-4">
        <div class="row justify-content-center">
          <div class="col-md-6">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                placeholder="Cerca utente..."
                aria-label="Cerca Utente"
                aria-describedby="search-button"
                v-model="searchUser" 
              />
              <button
                class="btn btn-outline-primary"
                type="button"
                id="search-button"
                @click="filterUsers" 
              >
                <i class="bi bi-search"></i> Cerca
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div
          v-for="user in users"
          :key="user.id"
          class="col-12 mb-4"
        >
          <div
            class="card bg-dark text-white shadow-lg rounded-3 w-100"
            id="clickableUserCard"
            @click="loadUser(user.id); showPage('userDetail')"
            style="transition: transform 0.3s ease, box-shadow 0.3s ease;"
          >
            <div class="card-body">
              <div class="d-flex flex-column align-items-start">
                <h5 class="card-title fw-bold fs-4 mb-2">{{ user.username }}</h5>
                <p class="card-text text-muted">{{ user.name }} {{ user.surname }}</p>
              </div>
            </div>
            <div
              class="card-footer bg-dark text-white d-flex justify-content-between align-items-center"
              style="border-top: 1px solid #444;"
            >
              <small class="text-muted">User ID: <span class="user-id">{{ user.id }}</span></small>
              <span class="badge bg-primary">Click for details</span>
            </div>
          </div>
        </div>
      </div>
      
    </div>

    <!--Pagina Dettaglio utente-->
    <div v-if="currentView === 'userDetail'" class="container mt-5">
      <div class="row mb-4 justify-content-center">
        <div class="col-md-8">
          <div class="card bg-dark text-white shadow-lg border-0">
            <div class="card-header bg-dark text-white text-center">
              <h4 class="mb-0">{{ user.username }}</h4>
            </div>
            <div class="card-body">
              <div class="d-flex flex-column align-items-start">
                <!-- Dettagli utente senza l'ID -->
                <p><strong>Nome:</strong> {{ user.name }}</p>
                <p><strong>Cognome:</strong> {{ user.surname }}</p>
              </div>
            </div>
            <div class="card-footer bg-dark text-white">
              <small>ID Utente: <span class="user-id">{{ user.id }}</span></small>
            </div>
          </div>
        </div>
      </div>
      <div v-if="wonAuctions.length">
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="btn-group w-100" role="group">
                <button
                class="btn btn-lg btn-outline-primary w-50" 
                id = "wonauctions" >
                Aste Vinte
              </button>
            </div>
          </div>
        </div>
        <div class="container mt-5">
        <table class="table table-dark table-striped table-hover shadow-sm">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Titolo</th>
              <th scope="col">Descrizione</th>
              <th scope="col">Prezzo Finale (€)</th>
              <th scope="col">Data di Fine</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="auction in wonAuctions" :key="auction.id"  @click.stop="loadAuctionDetail(auction.id); currentView = 'auctionDetail'">
              <td>{{ auction.id }}</td>
              <td>{{ auction.title }}</td>
              <td>{{ auction.description }}</td>
              <td>{{ auction.currentPrice }}</td>
              <td>{{ auction.endDate }}</td>
            </tr>
          </tbody>
        </table>
        </div>
      </div>
      <div v-if="!wonAuctions.length" class="alert alert-warning" role="alert">
        L'utente non ha ancora vinto alcuna asta!
      </div>
    </div>

  </body>
</html>
